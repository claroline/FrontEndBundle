(function(a,c){var b=function(d,e){this.editor=d;this.options=c.extend({},{source:[],delay:500,queryBy:"name",items:10},e);this.matcher=this.options.matcher||this.matcher;this.renderDropdown=this.options.renderDropdown||this.renderDropdown;this.render=this.options.render||this.render;this.insert=this.options.insert||this.insert;this.highlighter=this.options.highlighter||this.highlighter;this.query="";this.hasFocus=true;this.renderInput();this.bindEvents()};b.prototype={constructor:b,renderInput:function(){var d='<span id="autocomplete"><span id="autocomplete-delimiter">'+this.options.delimiter+'</span><span id="autocomplete-searchtext"><span class="dummy">\uFEFF</span></span></span>';this.editor.execCommand("mceInsertContent",false,d);this.editor.focus();this.editor.selection.select(this.editor.selection.dom.select("span#autocomplete-searchtext span")[0]);this.editor.selection.collapse(0)},bindEvents:function(){this.editor.on("keyup",this.editorKeyUpProxy=c.proxy(this.rteKeyUp,this));this.editor.on("keydown",this.editorKeyDownProxy=c.proxy(this.rteKeyDown,this));this.editor.on("click",this.editorClickProxy=c.proxy(this.rteClicked,this));var d=this.editor.__bindings.keydown.pop();this.editor.__bindings.keydown.unshift(d);c(this.editor.getWin()).on("scroll",this.rteScroll=c.proxy(function(){this.cleanUp(true)},this));c("body").on("click",this.bodyClickProxy=c.proxy(this.rteLostFocus,this))},unbindEvents:function(){this.editor.off("keyup",this.editorKeyUpProxy);this.editor.off("keydown",this.editorKeyDownProxy);this.editor.on("click",this.editorClickProxy);c(this.editor.getWin()).off("scroll",this.rteScroll);c("body").off("click",this.bodyClickProxy)},rteKeyUp:function(f){switch(f.which||f.keyCode){case 40:case 38:case 16:case 17:case 18:break;case 8:if(this.query===""){this.cleanUp(true)}else{this.lookup()}break;case 9:case 13:var d=(this.$dropdown!==undefined)?this.$dropdown.find("li.active"):[];if(d.length){this.select(d.data());this.cleanUp(false)}else{this.cleanUp(true)}break;case 27:this.cleanUp(true);break;default:this.lookup()}},rteKeyDown:function(d){switch(d.which||d.keyCode){case 9:case 13:case 27:d.preventDefault();break;case 38:d.preventDefault();if(this.$dropdown!==undefined){this.highlightPreviousResult()}break;case 40:d.preventDefault();if(this.$dropdown!==undefined){this.highlightNextResult()}break}d.stopPropagation()},rteClicked:function(f){var d=c(f.target);if(this.hasFocus&&d.parent().attr("id")!=="autocomplete-searchtext"){this.cleanUp(true)}},rteLostFocus:function(d,f){if(this.hasFocus){this.cleanUp(true)}},lookup:function(){this.query=c.trim(c(this.editor.getBody()).find("#autocomplete-searchtext").text()).replace("\ufeff","");if(this.$dropdown===undefined){this.show()}clearTimeout(this.searchTimeout);this.searchTimeout=setTimeout(c.proxy(function(){var d=c.isFunction(this.options.source)?this.options.source(this.query,c.proxy(this.process,this),this.options.delimiter):this.options.source;if(d){this.process(d)}},this),this.options.delay)},matcher:function(d){return ~d[this.options.queryBy].toLowerCase().indexOf(this.query.toLowerCase())},sorter:function(f){var g=[],e=[],d=[],h;while((h=f.shift())!==undefined){if(!h[this.options.queryBy].toLowerCase().indexOf(this.query.toLowerCase())){g.push(h)}else{if(~h[this.options.queryBy].indexOf(this.query)){e.push(h)}else{d.push(h)}}}return g.concat(e,d)},highlighter:function(d){return d.replace(new RegExp("("+this.query+")","ig"),function(e,f){return"<strong>"+f+"</strong>"})},show:function(){var h=c(this.editor.getContainer()).offset(),d=c(this.editor.getContentAreaContainer()).position(),g=c(this.editor.dom.select("span#autocomplete")).position(),f=h.top+d.top+g.top+c(this.editor.selection.getNode()).innerHeight()-c(this.editor.getDoc()).scrollTop()+5,e=h.left+d.left+g.left;this.$dropdown=c(this.renderDropdown()).css({top:f,left:e});c("body").append(this.$dropdown);this.$dropdown.on("click",c.proxy(this.autoCompleteClick,this))},process:function(f){if(!this.hasFocus){return}var g=this,d=[],e=c.grep(f,function(h){return g.matcher(h)});e=g.sorter(e);e=e.slice(0,this.options.items);c.each(e,function(j,k){var h=c(g.render(k));h.html(h.html().replace(h.text(),g.highlighter(h.text())));c.each(e[j],function(i,l){h.attr("data-"+i,l)});d.push(h[0].outerHTML)});if(d.length){this.$dropdown.html(d.join("")).show()}else{this.$dropdown.hide()}},renderDropdown:function(){return'<ul class="rte-autocomplete dropdown-menu"><li class="loading"></li></ul>'},render:function(d){return'<li><a href="javascript:;"><span>'+d.name+"</span></a></li>"},autoCompleteClick:function(f){var d=c(f.target).closest("li").data();if(!c.isEmptyObject(d)){this.select(d);this.cleanUp(false)}f.stopPropagation();f.preventDefault()},highlightPreviousResult:function(){var d=this.$dropdown.find("li.active").index(),e=(d===0)?this.$dropdown.find("li").length-1:--d;this.$dropdown.find("li").removeClass("active").eq(e).addClass("active")},highlightNextResult:function(){var d=this.$dropdown.find("li.active").index(),e=(d===this.$dropdown.find("li").length-1)?0:++d;this.$dropdown.find("li").removeClass("active").eq(e).addClass("active")},select:function(e){var d=this.editor.dom.select("span#autocomplete")[0];this.editor.dom.remove(d);this.editor.execCommand("mceInsertContent",false,this.insert(e)+"&nbsp;")},insert:function(d){return"<span>"+d.name+"</span>"},cleanUp:function(e){this.unbindEvents();this.hasFocus=false;if(this.$dropdown!==undefined){this.$dropdown.remove();delete this.$dropdown}if(e){var h=this.query,d=c(this.editor.dom.select("span#autocomplete")),g=c("<p>"+this.options.delimiter+h+"</p>")[0].firstChild,f=c(this.editor.selection.getNode()).offset().top===(d.offset().top+((d.outerHeight()-d.height())/2));this.editor.dom.replace(g,d[0]);if(f){this.editor.selection.select(g);this.editor.selection.collapse()}}}};a.create("tinymce.plugins.Mention",{init:function(d,f){var g,h=d.getParam("mentions");h.delimiter=(h.delimiter!==undefined)?!c.isArray(h.delimiter)?[h.delimiter]:h.delimiter:["@"];function e(){var i=c(d.selection.getNode().outerHTML),k=i.text(),j=k.substr(k.length-1,1);return(!!c.trim(j).length)?false:true}d.on("keypress",function(i){var j=c.inArray(String.fromCharCode(i.which||i.keyCode),h.delimiter);if(j>-1&&e()){if(g===undefined||(g.hasFocus!==undefined&&!g.hasFocus)){i.preventDefault();g=new b(d,c.extend({},h,{delimiter:h.delimiter[j]}))}}})},getInfo:function(){return{longname:"mention",author:"Steven Devooght",version:a.majorVersion+"."+a.minorVersion}}});a.PluginManager.add("mention",a.plugins.Mention)})(tinymce,jQuery);